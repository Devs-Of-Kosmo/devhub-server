<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Jua', sans-serif;
            display: flex;
            flex-direction: column;
        }

        .navbar-brand {
            font-weight: bold;
        }

        .board-image {
            max-width: 100%;
            height: auto;
        }

        .navbar-brand, .nav-link, h2, .form-label, .btn, .footer p {
            font-family: 'Jua', sans-serif;
        }

        .content-wrapper {
            flex: 1; /* 나머지 공간을 채우는 역할 */
        }

        .footer {
            background-color: #343a40;
            color: #ffffff;
            text-align: center;
            padding: 1rem;
            margin-top: auto;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/boards">팀원 구하기</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/boards">게시글 목록</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content-wrapper">
<div class="container mt-5">
    <h2 class="text-center mb-4">게시글 상세</h2>

    <div class="card">
        <div class="card-body">
            <h5 id="boardTitle" class="card-title"></h5>
            <h6 id="boardWriter" class="card-subtitle mb-2 text-muted"></h6>
            <p id="boardContent" class="card-text"></p>
            <img id="boardImage" class="img-fluid board-image" alt="게시글 이미지" style="display: none; max-width: 80%; height: auto; max-height: 250px;">
        </div>
    </div>

    <div class="mt-3">
        <button id="deleteButton" class="btn btn-danger" style="display: none;">삭제</button>
        <a id="editButton" href="#" class="btn btn-primary" style="display: none;">수정</a>
        <a href="/boards" class="btn btn-secondary">목록으로</a>
    </div>
</div>
</div>

<footer class="footer">
    <p class="mb-0">&copy; 2024 팀원 구하기. All rights reserved.</p>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        const pathSegments = window.location.pathname.split('/');
        const boardId = pathSegments[pathSegments.length - 1];
        const token = localStorage.getItem('accessToken'); // JWT 토큰을 로컬 스토리지에서 가져옴
        let userInfo = null;

        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/login';
            return;
        }

        // 사용자 정보를 먼저 가져온 후 게시글 정보를 가져옴
        $.ajax({
            url: '/api/user/info',
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function(data) {
                userInfo = data;
                console.log('User Info:', userInfo);
                fetchBoardData();
            },
            error: function(xhr, status, error) {
                console.error('Error fetching user info:', error);
                if (xhr.status === 401) {
                    alert('인증이 만료되었습니다. 다시 로그인해주세요.');
                    window.location.href = '/login';
                }
            }
        });

        // 게시글 정보를 가져오는 함수
        function fetchBoardData() {
            if (boardId) {
                $.ajax({
                    url: `/api/boards/${boardId}`,
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    success: function(data) {
                        console.log('Board Details:', data); // 응답 데이터 콘솔 출력
                        $('#boardTitle').text(data.title);
                        $('#boardWriter').text(extractUserName(data.writer)); // 이름만 사용
                        $('#boardContent').html(data.content);

                        if (data.imagePath) {
                            const imagePath = data.imagePath.startsWith('http') ? data.imagePath : `${window.location.origin}${data.imagePath}`;
                            $('#boardImage').attr('src', imagePath).show();
                        }

                        // 사용자 이름이 작성자와 같으면 버튼 표시
                        if (userInfo && userInfo.name === extractUserName(data.writer)) {
                            $('#deleteButton').show();
                            $('#editButton').show().attr('href', `/boards/edit/${boardId}`);
                        }

                        $('#deleteButton').click(function() {
                            if (confirm('정말로 이 게시글을 삭제하시겠습니까?')) {
                                $.ajax({
                                    url: `/api/boards/${boardId}`,
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    },
                                    success: function() {
                                        alert('게시글이 삭제되었습니다.');
                                        window.location.href = '/boards';
                                    },
                                    error: function(xhr, status, error) {
                                        console.error('Error:', error);
                                        alert('게시글 삭제에 실패했습니다.');
                                    }
                                });
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                        alert('게시글을 불러오는데 실패했습니다.');
                    }
                });
            } else {
                alert('유효하지 않은 게시글 ID입니다.');
                window.location.href = '/boards';
            }
        }
    });

    function extractUserName(writerString) {
        const nameMatch = writerString.match(/name=([^,]+)/);
        return nameMatch ? nameMatch[1] : '알 수 없음';
    }
</script>

</body>
</html>
