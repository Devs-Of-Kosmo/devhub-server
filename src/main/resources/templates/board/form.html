<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 작성</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">팀원 구하기</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/boards">게시글 목록</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h2 class="text-center mb-4" id="form-title">게시글 작성</h2>
    <form id="boardRequest-form">
        <input type="hidden" id="boardRequest-id" name="id">

        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input type="text" class="form-control" id="title" name="title" required>
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea class="form-control" id="content" name="content"></textarea>
        </div>

        <div class="mb-3">
            <label for="writer" class="form-label">작성자</label>
            <input type="text" class="form-control" id="writer" name="writer" required readonly>
        </div>

        <div class="mb-3">
            <label for="file" class="form-label">이미지 업로드</label>
            <input type="file" class="form-control" id="file" name="file" onchange="previewImage(event)">
            <img id="preview" src="#" alt="이미지 미리보기" class="boardRequest-image mt-3" style="display: none;">
        </div>

        <button type="submit" class="btn btn-primary">저장</button>
        <a href="/boards" class="btn btn-secondary">취소</a>
    </form>
</div>

<footer class="bg-dark text-white text-center py-5 mt-5">
    <div class="container">
        <p>&copy; 2023 팀원 구하기. All rights reserved.</p>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/29.1.0/classic/ckeditor.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function previewImage(event) {
        var reader = new FileReader();
        reader.onload = function(){
            var output = document.getElementById('preview');
            output.src = reader.result;
            output.style.display = 'block';
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    $(document).ready(function() {
        ClassicEditor
            .create(document.querySelector('#content'), {
                language: 'ko'
            })
            .then(editor => {
                window.editor = editor;
                fetchUserInfo(); // 유저 정보 조회
            })
            .catch(error => {
                console.error(error);
            });

        $('#boardRequest-form').on('submit', function(event) {
            event.preventDefault();
            syncEditorData();
            submitForm();
        });
    });

    function fetchUserInfo() {
        const token = localStorage.getItem('accessToken'); // JWT 토큰을 로컬 스토리지에서 가져옴

        $.ajax({
            url: '/api/user/info',
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function(data) {
                console.log('User Info:', data); // 응답 데이터 콘솔 출력
                // 유저 정보를 기반으로 작성자 필드 자동 채움 및 읽기 전용 설정
                if (data.name) {
                    $('#writer').val(data.name);
                } else {
                    console.error('Username is missing in the response');
                }
                initializeForm();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error('Error:', errorThrown);
                if (jqXHR.status === 401) {
                    alert('인증이 만료되었습니다. 다시 로그인해주세요.');
                    window.location.href = '/login';
                }
            }
        });
    }

    function syncEditorData() {
        const editorData = window.editor.getData();
        $('#content').val(editorData);
    }

    function initializeForm() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        if (id) {
            $('#form-title').text('게시글 수정');
            fetchWithAuth(`/api/boards/${id}`)
                .done(data => {
                    console.log('Board Info:', data); // 응답 데이터 콘솔 출력
                    $('#boardRequest-id').val(data.id);
                    $('#title').val(data.title);
                    $('#content').val(data.content);
                    $('#writer').val(data.writer.name); // 작성자 이름만 사용

                    if (data.imagePath) {
                        $('#preview').attr('src', `/images/${data.imagePath}`).show();
                    }
                })
                .fail((jqXHR, textStatus, errorThrown) => {
                    console.error('Error:', errorThrown);
                    if (jqXHR.status === 401) {
                        alert('인증이 만료되었습니다. 다시 로그인해주세요.');
                        window.location.href = '/login';
                    }
                });
        } else {
            $('#form-title').text('게시글 작성');
        }
    }

    function submitForm() {
        syncEditorData(); // 에디터 데이터 동기화
        const formData = new FormData($('#boardRequest-form')[0]);
        const id = $('#boardRequest-id').val();
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/boards/${id}` : '/api/boards';
        const token = localStorage.getItem('accessToken'); // JWT 토큰을 로컬 스토리지에서 가져옴




        $.ajax({
            url: url,
            method: method,
            headers: {
                'Authorization': `Bearer ${token}` // 헤더에 JWT 토큰 추가
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                window.location.href = '/boards';
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error('Error:', errorThrown);
                if (jqXHR.status === 401) {
                    alert('인증이 만료되었습니다. 다시 로그인해주세요.');
                    window.location.href = '/login';
                }
            }
        });
    }

    function fetchWithAuth(url) {
        const token = localStorage.getItem('accessToken'); // JWT 토큰을 로컬 스토리지에서 가져옴
        return $.ajax({
            url: url,
            headers: {
                'Authorization': `Bearer ${token}` // 헤더에 JWT 토큰 추가
            }
        });
    }
</script>
</body>
</html>
